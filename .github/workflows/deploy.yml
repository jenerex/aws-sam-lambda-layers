- name: Install dependencies in Lambda Layer
  run: |
    cd layers/nodejs
    npm ci --only=prod

- name: Clean previous SAM build
  run: rm -rf .aws-sam

- name: Build with SAM
  run: sam build --use-container

- name: Package with SAM
  run: |
    sam package \ 
      --template-file template.yaml \
      --s3-bucket ${{ secrets.DEPLOY_S3_BUCKET }} \
      --output-template-file packaged.yaml

- name: Deploy with SAM
  env:
    MONGO_URI: ${{ secrets.MONGO_URI }}
  run: |
    sam deploy \
      --template-file packaged.yaml \
      --stack-name auth-app-prod-v3 \
      --capabilities CAPABILITY_IAM \
      --region ap-south-1 \
      --parameter-overrides MongoUriParam="${MONGO_URI}" \
      --no-confirm-changeset \
      --no-fail-on-empty-changeset
